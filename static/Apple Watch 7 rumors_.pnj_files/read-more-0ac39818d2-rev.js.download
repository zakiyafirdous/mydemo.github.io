define(["jquery","version!fly/managers/debug","version!fly/managers/components","managers/ad","managers/page-vars","version!fly/components/base","version!libs/jquery/mobile"],function(t,a,e,n,s){a=a.init("readMore"),t.widget("cnet.readMore",t.fly.base,{options:{classActive:"active",classInactive:"inactive",classLoading:"loading",event:"click",id:"",selectorClose:'[data-read-more="close"]',selectorContainer:'[data-read-more="container"]',stopTouchPropagation:!0,url:"",openOnClick:!1,injectionType:""},$close:null,$container:null,$trigger:null,ajaxEnabled:!0,loaded:!1,openOnLoad:!1,adData:null,trackingData:null,_create:function(){this._setup(),this.$close=t(this.options.selectorClose,this.$element),this.$container=t(this.options.selectorContainer,this.$element),this.$trigger=t('[data-read-more-trigger="'+this.options.id+'"]'),this._setupEvents()},_setupEvents:function(){var t=this;"ready"===this.options.event?this.loadAndOpen():this.$trigger.on(this.options.event,function(a){a.preventDefault(),t.$element.hasClass(t.options.classActive)||t.$element.hasClass(t.options.classLoading)?t.close():t.loadAndOpen()}),this.$close.on("click",function(a){t.close()}),this.options.stopTouchPropagation&&this.$element.on("touchmove",function(t){t.stopPropagation()})},open:function(){this.$element.addClass(this.options.classActive).removeClass(this.options.classInactive).removeClass(this.options.classLoading),this._trigger("opened",null,{adData:this.adData,trackingData:this.trackingData})},close:function(){(this.$element.hasClass(this.options.classActive)||this.$element.hasClass(this.options.classLoading))&&(this.$element.removeClass(this.options.classActive).removeClass(this.options.classLoading).addClass(this.options.classInactive),this._trigger("closed",null,{adData:this.adData,trackingData:this.trackingData}))},load:function(){var i=this;if(this.$element.addClass(this.options.classLoading),this.options.openOnClick&&i.open(),this.ajaxEnabled){this.ajaxEnabled=!1;var o=this.options.url,l=window.location.search;o.search("\\?")>-1&&l.search("\\?")>-1&&(l=l.replace("?","&")),o+=l,t.ajax({dataType:"json",url:o}).done(function(o){if(o.html){var l="string"==typeof o?JSON.parse(o.html):o;i.loaded=!0,i.adData=l.adData||{},i.trackingData=l.trackingData||{},"append"===i.options.injectionType?i.$container.append(l.html):i.$container.html(l.html),e.process(i.$container),i.openOnLoad&&!i.options.openOnClick&&i.open(),i.adData&&i.adData.gpt&&(s.ads.data=t.extend(!0,i.adData,{gpt:{targeting:s.ads.data.gpt.targeting,slotVars:s.ads.data.gpt.slotVars}}),n.loadAds(n.getAdUnits(s.ads.data.gpt.containerId),s.ads.data,{excludeDisabled:!0,incrementPageView:!0})),a.log("Firing event contentinjected",i.options.id),i._trigger("contentinjected")}else a.log("HTML response not found"),i.ajaxEnabled=!0,i._trigger("closed")}).fail(function(){a.log("Failed to load additional content"),i.ajaxEnabled=!0,i._trigger("closed")})}},loadAndOpen:function(){this._trigger("open",null,{id:this.options.id}),this.openOnLoad=!0,this.loaded?this.open():this.load()}})});